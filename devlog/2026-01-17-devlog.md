# 2026-01-17 開發日誌

## 開發規劃 (Planning)
- [x] 修復 CI/CD 部署流程 (Fix CI/CD Pipeline)
- [x] 解決 SSH Key 驗證失敗問題
- [x] 修正考勤資料錯誤 (未來時間/重置問題)
- [x] 實作考勤列表分頁與篩選功能

## 專案結構 (Project Structure)
*(本日主要變更集中於 .github/workflows, backend/src/attendance, frontend/src/pages/attendance)*

## 進度 (Progress)
- 完成 CI/CD 流程修復，成功自動部署至 AWS EC2。
- 修正後端 AttendanceService，移除 Mock Data，改接 Prisma 資料庫。
- 修正 docker/prod/Dockerfile.backend，確保 Prisma Client 正確生成。
- 實作前後端分頁 (Pagination) 與篩選 (Filter) 功能。
- 優化前端分頁顯示邏輯。

## Git 提交記錄
- **提交時間**: 15:00 (Approx)
- **提交訊息**:
  - `fix(ci): specify correct go.sum path for cache`
  - `fix(backend): replace mock attendance with real database storage`
  - `fix(docker): run prisma generate before backend build`
  - `fix(frontend): correctly identify latest attendance record (index 0)`
  - `feat(attendance): add pagination and user filtering`
  - `fix(frontend): always show pagination controls`
- **變更統計**: 多個前後端檔案更新

## Mobile App Status Check (2026-01-17)
- **Status**: 基礎框架建立完成 (Foundation Setup Completed)
- **Dependencies**: `flutter_riverpod`, `go_router`, `dio`, `flutter_secure_storage`
- **Backup**: 
  - Location: `c:\Users\BillW\Desktop\code\ERP\backups\mobile_backup_20260117`
  - Content: Full `mobile` directory copy (excluding build/cache)
- **Current Structure**:
  - `lib/core`: Router & Utils
  - `lib/features`: Feature modules (Dashboard, Auth, etc.)
  - `main.dart`: Entry point with ProviderScope & Router

## Mobile Login Fix (2026-01-17)
- **Problem**: 
  1. Connected to wrong service (Bookkeeping @ Port 80 instead of ERP @ Port 8080).
  2. Login payload mismatch (`username` vs `account`).
  3. CORS blocked requests from Flutter Web.
- **Solution**:
  - Updated `dio_client.dart` baseUrl to `http://54.255.186.244:8080/api`.
  - Reverted `auth_service.dart` to use `account` parameter.
  - Enabled CORS in `backend/src/main.ts` (Requires Deployment).
  - Workaround: Run with `--disable-web-security`.

## Git 提交記錄 (Post-Fix)
- **提交時間**: 21:45
- **提交 Hash**: `690228f`
- **提交訊息**: fix(mobile): connect to remote erp backend and fix login payload
- **Backup**: `c:\Users\BillW\Desktop\code\ERP\backups\mobile_backup_20260117_post_fix`

## Final Backup (Final)
- **Time**: 22:00
- **Location**: `c:\Users\BillW\Desktop\code\ERP\backups\mobile_backup_20260117_final`
- **Status**: Mobile App fully functional, Backend CORS patched.

## Server Optimization (2026-01-17)
- **Problem**: High CPU/Memory usage due to dual stack (ERP + Bookkeeping).
- **Action 1**: Decommissioned `bookkeeping` legacy containers (Frontend, Backend, DB, Redis).
- **Action 2**: Enabled 2GB Swap Memory (`/swapfile`).
- **Action 3**: Force removed zombie `bookkeeping-postgres` container (found causing residual load).
- **Result**: Reduced running container count from ~9 to 5. Increased available virtual memory.

## Mobile Todo Feature (2026-01-17)
- **Backend Refactor**: 
  - Modified `TodosService` to store data in PostgreSQL (via Prisma) instead of memory.
  - Deployed updates to server.
- **Mobile App**:
  - Implemented `Todo` Model, Service, and Repository.
  - Created `TodoScreen` for listing/adding/deleting todos.
  - Integrated top 2 todos preview into `DashboardScreen`.
  - Added **Quick Add (+) Button** on Dashboard header for convenience.
  - Implemented **Auto-hide** logic: Completed items disappear after 5 seconds to match web behavior.
  - Enabled **Direct Completion** from Dashboard: Users can now tick off items directly from the home screen.
  - Added **Overflow Indicator**: Shows "X items hidden" when todo list exceeds preview limit.
  - Implemented **Real-time Chat**:
    - Added Contact List screen (filtered current user).
    - Integrated WebSocket for real-time messaging.
    - Added Chat entry point (Bubble Icon) to Dashboard AppBar.

